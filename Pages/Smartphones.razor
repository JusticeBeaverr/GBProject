@inject ViewModels.Smartphone.ISmartphoneViewModel viewModel
@using GadgetBlitzPZ.Models.Smartphone
@using GadgetBlitzPZ.Pages.Templates
@using System.Linq
@using Blazorise.Icons.FontAwesome
@using Microsoft.JSInterop

@page "/smartphones"

<PageTitle>Smartphones</PageTitle>

<Style></Style>

<div class="container-fluid mt-4 mb-4">
	<div class="row">
		<div class="col-md-2">
			<!-- Pasek z filtrowaniem wyników -->
			<div class="navbar navbar-expand-md navbar-light bg-light flex-md-column custom-shadow">
				<ul class="navbar-nav flex-md-column">
					<!-- Marka -->
					<h5>Marka</h5>
					<div>
						@foreach (var brand in availableBrands)
						{
							<div class="form-check">
								<input class="form-check-input custom-shadow-checkbox" type="checkbox" id="@($"brand-{brand.Key}")" checked="@brandChecked[brand.Key]" @onchange="() => ToggleBrandSelection(brand.Value, brand.Key)" />
								<label class="form-check-label" for="@($"brand-{brand.Key}")">
									@brand.Value
								</label>
							</div>
						}
					</div>

					<!-- Wielkość ekranu -->
					<li class="nav-item mt-2 mb-2">
						<h5>Wielkość ekranu</h5>
						<div class="input-group custom-shadow">
							<select class="form-select" id="sizeMin" @bind="sizeMin">
								<option value="4">4"</option>
								<option value="5">5"</option>
								<option value="6">6"</option>
								<option value="7">7"</option>
								<option value="8">8"</option>
							</select>
							<div class="input-group-text">do</div>
							<select class="form-select" id="sizeMax" @bind="sizeMax">
								<option value="4">4"</option>
								<option value="5">5"</option>
								<option value="6">6"</option>
								<option value="7">7"</option>
								<option value="8">8"</option>
							</select>
						</div>
					</li>
					<!-- Bateria -->
					<li class="nav-item mt-2 mb-2">
						<h5>Pojemność baterii</h5>
						<div class="input-group custom-shadow">
							<select class="form-select" id="batteryMin" @bind="batteryMin">
								<option value="1000">1000mAh</option>
								<option value="2000">2000mAh</option>
								<option value="3000">3000mAh</option>
								<option value="4000">4000mAh</option>
								<option value="5000">5000mAh</option>
								<option value="6000">6000mAh</option>
							</select>
							<div class="input-group-text">do</div>
							<select class="form-select" id="batteryMax" @bind="batteryMax">
								<option value="1000">1000mAh</option>
								<option value="2000">2000mAh</option>
								<option value="3000">3000mAh</option>
								<option value="4000">4000mAh</option>
								<option value="5000">5000mAh</option>
								<option value="6000">6000mAh</option>
							</select>
						</div>
					</li>
					<!-- Pamięć masowa -->
					<li class="nav-item mt-2 mb-2">
						<h5>Pamięć</h5>
						<div class="input-group custom-shadow">
							<select class="form-select" id="storageMin" @bind="storageMin">
								<option value="16">16GB</option>
								<option value="32">32GB</option>
								<option value="64">64GB</option>
								<option value="128">128GB</option>
								<option value="256">256GB</option>
								<option value="512">512GB</option>
								<option value="1024">1TB</option>
								<option value="2048">2TB</option>
							</select>
							<div class="input-group-text">do</div>
							<select class="form-select" id="storageMax" @bind="storageMax">
								<option value="16">16GB</option>
								<option value="32">32GB</option>
								<option value="64">64GB</option>
								<option value="128">128GB</option>
								<option value="256">256GB</option>
								<option value="512">512GB</option>
								<option value="1024">1TB</option>
								<option value="2048">2TB</option>
							</select>
						</div>
					</li>

					<!-- System-->
					<li class="nav-item mt-2 mb-2">
						<h5>System operacyjny</h5>
						<div class="form-check">
							<input class="form-check-input custom-shadow-checkbox" type="checkbox" value="Android" id="os1" @bind="osChecked[0]">
							<label class="form-check-label" for="os1">
								Android
							</label>
						</div>
						<div class="form-check">
							<input class="form-check-input custom-shadow-checkbox" type="checkbox" value="iOS" id="os2" @bind="osChecked[1]">
							<label class="form-check-label" for="os2">
								iOS
							</label>
						</div>
						<!-- Dodaj więcej opcji systemów operacyjnych -->
					</li>
					<li class="nav-item mt-2 mb-2">
						<h5>Zakres cenowy</h5>
						<div class="input-group custom-shadow">
							<input type="number" class="form-control" id="priceMin" min="0" placeholder="zł" step="100" @bind="priceMin">
							<div class="input-group-text">do</div>
							<input type="number" class="form-control" id="priceMax" min="@priceMin" placeholder="zł" step="100" @bind="priceMax">
						</div>
					</li>
					<!-- Dodaj więcej filtrów -->
				</ul>
				<button class="btn btn-secondary mt-1 custom-shadow" style="width: 80%;" @onclick="ClearAll">Wyczyść wszystkie filtry</button>
				<button class="btn btn-primary btn-lg text-xl mt-1 mb-1 custom-shadow" style="width: 80%;" @onclick="LoadFilters">Szukaj</button>

				<Dropdown Class="mt-3 custom-shadow" Style="width: 80%;">
					<DropdownToggle Color="Color.Dark" Style="width: 100%;">
						Porównywarka (@viewModel.SmartphonesComparisonList.Count)
					</DropdownToggle>
					<DropdownMenu>
						@foreach (var smartphone in viewModel.SmartphonesComparisonList)
						{
							<div class="d-flex align-items-center">
								@if (smartphone.urls != null && smartphone.urls.Any())
								{
									<img src="@smartphone.urls.First()" alt="Smartphone Image" style="width: 60px; height: 60px; object-fit: cover; object-position: center; border-radius: 5%; margin-right: 2px;" />
								}
								else
								{
									<i class="fas fa-mobile-alt fa-3x" style="margin-right: 10px;"></i>
								}
								<span class="flex-grow-1">@smartphone.name</span>
								<button class="btn btn-link" @onclick="() => viewModel.RemoveFromComparison(smartphone)">
									<i class="fas fa-times"></i>
								</button>
							</div>
						}
					</DropdownMenu>
				</Dropdown>



			</div>
		</div>
		<div class="col-md-8">
			<!-- Lista ze smartfonami -->
			@if (viewModel.SmartphonesList != null)
			{
				<div class="row">
					@foreach (var smartphone in viewModel.SmartphonesList)
					{
						<div class="col-md-4 mb-4">
							<div class="card custom-shadow d-flex flex-column justify-content-between" style="height: 400px">
								<div class="card-body d-flex align-items-center">
									<div class="mr-3">
										@if (smartphone.urls != null && smartphone.urls.Any())
										{
											<img src="@smartphone.urls.First()" alt="Smartphone Image" style="width: 160px; height: 200px; object-fit: cover; object-position: center; border-radius: 3%; transform: scale(0.9);" />
										}
									</div>
									<div class="card-body text-center">
										<h5 class="card-title">@smartphone.name</h5>
										<p class="card-text small">
											<strong>Ekran:</strong> @smartphone.size "<br />
											<strong>Bateria:</strong> @smartphone.battery mAh<br />
											<strong>System:</strong> @smartphone.system<br />
											<strong>Pamięć:</strong> @smartphone.storage  GB<br />
											<strong>Cena:</strong> @smartphone.price $
										</p>
									</div>
								</div>
								<div class="card-footer">
									<div class="row align-items-center">
										<div class="col-md-6">
											<div class="form-check d-flex align-items-center">
												@if (viewModel.SmartphonesComparisonList.Count < 3)
												{
													<button class="btn btn-outline-dark custom-shadow" @onclick="() => viewModel.AddToComparison(smartphone)">Dodaj do porównania</button>

												}
												else
												{

													<Tooltip Text="Dodano maksymalną ilość telefonów do porównywarki">
														<button class="btn btn-outline-dark custom-shadow" disabled>Dodaj do porównania</button>
													</Tooltip>
												}
											</div>
										</div>
										<div class="col-md-6 text-md-right">
											@if (viewModel.SmartphonesList.IndexOf(smartphone) % 2 == 0)
											{
												<button class="btn btn-primary btn-md mb-1 font-weight-bold custom-shadow">Dane Techniczne</button>
											}
											else
											{
												<button class="btn btn-secondary btn-md mb-1 font-weight-bold custom-shadow">Dane Techniczne</button>
											}
										</div>
									</div>
								</div>
							</div>
						</div>
					}
				</div>
			}
			else
			{
				<div class="alert alert-warning" role="alert" style="width: 20%;">
					Nie znaleziono telefonów odpowiadających kryteriom wyszukiwania.
					<button class="btn btn-secondary mt-1" style="width: 100%;" @onclick="ClearAll">Wyczyść wszystkie filtry</button>
				</div>
			}
		</div>

		<div class="col-md-2">
			<AdBar></AdBar>
		</div>
	</div>
	<!-- Poprzednia i Nastepna strona-->
	@if (viewModel.totalPages != 0)
	{
		<div class="text-center d-flex justify-content-center align-items-center">
			<button class="btn btn-secondary btn-lg mb-1 mr-1 ml-1 text-xl custom-shadow" style="width: 12%;" @onclick="PrevPage" disabled="@isFirstPage">Poprzednia Strona</button>
			<div style="width: 12%; max-width: 200px;">
				<span>Strona @pageIndex z @viewModel.totalPages</span>
			</div>
			<button class="btn btn-primary btn-lg mb-1 mr-1 ml-1 text-xl custom-shadow" style="width: 12%;" @onclick="NextPage" disabled="@isLastPage">Następna Strona</button>
		</div>
	}

	<Modal @ref="ComparisonAlert">
		<ModalContent Centered>
			<ModalHeader>
				<ModalTitle>Sign Up</ModalTitle>
				<CloseButton />
			</ModalHeader>
			<ModalBody>
				<Validations Mode="ValidationMode.Auto">
					<Validation>
						<Field Horizontal>
							<FieldLabel ColumnSize="ColumnSize.Is2">First Name</FieldLabel>
							<FieldBody ColumnSize="ColumnSize.Is10">
								<TextEdit Placeholder="Enter Last Name">

								</TextEdit>
							</FieldBody>
						</Field>
					</Validation>
					<Validation>
						<Field Horizontal>
							<FieldLabel ColumnSize="ColumnSize.Is2">Last Name</FieldLabel>
							<FieldBody ColumnSize="ColumnSize.Is10">
								<TextEdit Placeholder="Enter Last Name">

								</TextEdit>
							</FieldBody>
						</Field>
					</Validation>

				</Validations>
			</ModalBody>
			<ModalFooter>
				<Button Color="Color.Secondary">Close</Button>
			</ModalFooter>
		</ModalContent>
	</Modal>


</div>


@code {
	private Modal ComparisonAlert;
	int comparisonCount = 0;

	int pageIndex = 1;
	public bool isFirstPage => pageIndex == 1;
	public bool isLastPage => pageIndex == viewModel.totalPages;

	Dictionary<int, string> availableBrands = new Dictionary<int, string>
{
	{ 0, "Apple" },
	{ 1, "Samsung" },
	{ 2, "Huawei" },
	{ 3, "Xiaomi" },
	{ 4, "OPPO" },
	{ 5, "Motorola" },
	{ 6, "Nokia" },
};
	List<string> selectedBrands = new List<string>();
	private bool[] brandChecked = new bool[7];

	private int sizeMin;
	private int sizeMax;

	private int batteryMin;
	private int batteryMax;

	private int storageMin;
	private int storageMax;

	private bool[] osChecked = new bool[3];

	private int priceMin;
	private int priceMax;

	string filterQuery = "phones?";

	protected override async Task OnInitializedAsync()
	{
		selectedBrands.Clear();
		await viewModel.GetSmartphones("phones?page=1&size=9");
		await viewModel.GetPages("phones?page=1&size=9");
	}

	private async Task ClearAll()
	{
		brandChecked = new bool[7];
		selectedBrands.Clear();

		sizeMin = 0;
		sizeMax = 0;

		batteryMin = 0;
		batteryMax = 0;

		storageMin = 0;
		storageMax = 0;

		osChecked = new bool[3];

		priceMin = 0;
		priceMax = 0;

		await viewModel.GetSmartphones("phones?page=1&size=9");
		await viewModel.GetPages("phones?page=1&size=9");
		StateHasChanged();
	}

	private async Task LoadFilters()
	{
		CheckAndSwap();

		filterQuery = "";

		// Brand filter
		if (selectedBrands.Count > 0)
		{
			string selectedBrandsQuery = string.Join(",", selectedBrands);
			filterQuery += $"phones/search?brand={selectedBrandsQuery}" + LoadValues();
		}
		else
		{
			if (LoadValues().Length > 0)
			{
				filterQuery += "phones/search?" + LoadValues().Substring(1);
			}
			else
			{
				filterQuery += "phones/search?" + LoadValues();
			}

		}

		await viewModel.GetSmartphones(filterQuery + "&size=9");
		await viewModel.GetPages(filterQuery);
		pageIndex = 1;
		StateHasChanged();
	}
	private string LoadValues()
	{
		string final = "";

		if (sizeMin != 0)
		{
			final += $"&sizeMin={sizeMin}";
		}
		if (sizeMax != 0)
		{
			final += $"&sizeMax={sizeMax}";
		}
		if (batteryMin != 0)
		{
			final += $"&batteryMin={batteryMin}";
		}
		if (batteryMax != 0)
		{
			final += $"&batteryMax={batteryMax}";
		}
		if (storageMin != 0)
		{
			final += $"&storageMin={storageMin}";
		}
		if (storageMax != 0)
		{
			final += $"&storageMax={storageMax}";
		}
		if (priceMin != 0)
		{
			final += $"&priceMin={priceMin}";
		}
		if (priceMax != 0)
		{
			final += $"&priceMax={priceMax}";
		}
		return final;
	}

	private void ToggleBrandSelection(string brandName, int brandKey)
	{
		brandChecked[brandKey] = !brandChecked[brandKey];

		if (brandChecked[brandKey])
		{
			if (!selectedBrands.Contains(brandName))
			{
				selectedBrands.Add(brandName);
			}
		}
		else
		{
			selectedBrands.Remove(brandName);
		}
	}

	private async Task NextPage()
	{
		if (pageIndex < viewModel.totalPages) // Add max page
		{
			string pageQuery = "";

			pageIndex++;
			pageQuery = "&size=9" + $"&page={pageIndex}";
			await viewModel.GetSmartphones(filterQuery + pageQuery);
			StateHasChanged();
		}
	}

	private async Task PrevPage()
	{
		if (pageIndex > 1)
		{
			string pageQuery = "";

			pageIndex--;
			pageQuery = "&size=9" + $"&page={pageIndex}";
			await viewModel.GetSmartphones(filterQuery + pageQuery);
			StateHasChanged();
		}
	}

	private void Swap<T>(ref T a, ref T b)
	{
		T temp = a;
		a = b;
		b = temp;
	}
	private void CheckAndSwap()
	{
		if (sizeMin > sizeMax && sizeMin != 0 && sizeMax != 0)
		{
			Swap(ref sizeMin, ref sizeMax);
		}
		if (batteryMin > batteryMax && batteryMin != 0 && batteryMax != 0)
		{
			Swap(ref batteryMin, ref batteryMax);
		}
		if (storageMin > storageMax && storageMin != 0 && storageMax != 0)
		{
			Swap(ref storageMin, ref storageMax);
		}
		if (priceMin > priceMax && priceMin != 0 && priceMax != 0)
		{
			Swap(ref priceMin, ref priceMax);
		}
	}

	private Task ShowComparisonAlert()
	{
		return ComparisonAlert.Show();
	}
}
